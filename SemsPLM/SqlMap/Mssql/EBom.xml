<?xml version="1.0" encoding="utf-8" ?>
<sqlMap
 namespace="EBom"
	xmlns="http://ibatis.apache.org/mapping"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <alias>
    <typeAlias alias="EBom"  type="EBom.Models.EBOM" />
    <typeAlias alias="EPart" type="EBom.Models.EPart" />
  </alias>

  <statements>

    <select id="SelNot1LvParentEPart" parameterClass="EPart" resultClass="EPart">
      SELECT
      A.*
      , B.*
      FROM T_DOBJECT A
      LEFT OUTER JOIN T_DEPART B ON B.OID = A.OID
      WHERE A.DeleteDt IS NULL
      AND A.Type = 'PART'
      <isNotNull property="OID">
        AND A.OID = #OID#
      </isNotNull>
      <isNotNull property="Name">
        AND A.Name like '%' + #Name# + '%'
      </isNotNull>
      <isNotNull property="Car_Lib_OID">
        AND B.Car_Lib_OID = #Car_Lib_OID#
      </isNotNull>
      <isNotNull property="EPartType">
        AND B.EPartType = #EPartType#
      </isNotNull>
      <isNotNull property="Division">
        AND B.Division = #Division#
      </isNotNull>
      <isNotNull property="ITEM_No">
        AND B.ITEM_No = #ITEM_No#
      </isNotNull>
      <isNotNull property="StartCreateDt">
        AND A.CreateDt &gt;= #StartCreateDt#
      </isNotNull>
      <isNotNull property="EndCreateDt">
        AND A.CreateDt &lt;= #EndCreateDt#
      </isNotNull>
      <isNotNull property="TdmxOID">
        AND A.TdmxOID != #TdmxOID#
      </isNotNull>
      <isNotNull property="IsLatest">
        AND A.IsLatest = #IsLatest#
      </isNotNull>
      <isNotNull property="IsReleasedLatest">
        AND A.IsReleasedLatest = #IsReleasedLatest#
      </isNotNull>
      <isNotNull property="Title">
        AND B.Title like '%' + #Title# + '%'
      </isNotNull>
      <isNotNull property="ITEM_Middle">
        AND B.ITEM_Middle = #ITEM_Middle#
      </isNotNull>
      ORDER BY A.CreateDt DESC
    </select>
    

    <select id="SelEPart" parameterClass="EPart" resultClass="EPart">
      SELECT
      A.*
      , B.*
      FROM T_DOBJECT A
      LEFT OUTER JOIN T_DEPART B ON B.OID = A.OID
      WHERE A.DeleteDt IS NULL
      AND A.Type = 'PART'
      <isNotNull property="OID">
        AND A.OID = #OID#
      </isNotNull>
      <isNotNull property="Name">
        AND A.Name like '%' + #Name# + '%'
      </isNotNull>
      <isNotNull property="Car_Lib_OID">
        AND B.Car_Lib_OID = #Car_Lib_OID#
      </isNotNull>
      <isNotNull property="EPartType">
        AND B.EPartType = #EPartType#
      </isNotNull>
      <isNotNull property="Division">
        AND B.Division = #Division#
      </isNotNull>
      <isNotNull property="ITEM_No">
        AND B.ITEM_No = #ITEM_No#
      </isNotNull>
      <isNotNull property="StartCreateDt">
        AND A.CreateDt &gt;= #StartCreateDt#
      </isNotNull>
      <isNotNull property="EndCreateDt">
        AND A.CreateDt &lt;= #EndCreateDt#
      </isNotNull>
      <isNotNull property="TdmxOID">
        AND A.TdmxOID = #TdmxOID#
      </isNotNull>
      <isNotNull property="IsLatest">
        AND A.IsLatest = #IsLatest#
      </isNotNull>
      <isNotNull property="IsReleasedLatest">
        AND A.IsReleasedLatest = #IsReleasedLatest#
      </isNotNull>
      <isNotNull property="Title">
        AND B.Title like '%' + #Title# + '%'
      </isNotNull>
      <isNotNull property="ITEM_Middle">
        AND B.ITEM_Middle = #ITEM_Middle#
      </isNotNull>
      ORDER BY A.CreateDt DESC
    </select>

    <select id="ChkEPart" parameterClass="EPart" resultClass="EPart">
      SELECT
      A.*
      , B.*
      FROM T_DOBJECT A
      LEFT OUTER JOIN T_DEPART B ON B.OID = A.OID
      WHERE A.DeleteDt IS NULL
      AND A.Type = 'PART'
      AND A.Name = #Name#
    </select>

    <select id="ChkEPartDivision" parameterClass="EPart" resultClass="EPart">
      SELECT
      A.*
      , B.*
      FROM T_DOBJECT A
      LEFT OUTER JOIN T_DEPART B ON B.OID = A.OID
      WHERE A.DeleteDt IS NULL
      AND A.Type = 'PART'
      AND A.Name like #Name# + '%'
    </select>

    <select id="SelEBom" parameterClass="EBom" resultClass="EBom">
      SELECT A.*
      FROM T_DEBOM_RELATIONSHIP A
      LEFT OUTER JOIN T_DEPART B ON B.OID = A.ToOID
      WHERE A.DeleteDt IS NULL
      AND A.Type = 'PART'
      <isNotNull property="OID">
        AND A.OID = #OID#
      </isNotNull>
      <isNotNull property="FromOID">
        AND A.FromOID = #FromOID#
      </isNotNull>
      <isNotNull property="ToOID">
        AND A.ToOID = #ToOID#
      </isNotNull>
    </select>

    <insert id="InsEPart" parameterClass="EPart" >
      INSERT INTO T_DEPART
      ( OID
      , Title
      , Oem_Lib_OID
      , Car_Lib_OID
      , Material_OID
      , Division
      , EPartType
      , ITEM_No
      , ITEM_Middle
      , Production_Place
      , Block_No
      , Serial
      , Sel_Revision
      , Standard
      )
      VALUES
      (#OID#
      , #Title#
      , #Oem_Lib_OID#
      , #Car_Lib_OID#
      , #Material_OID#
      , #Division#
      , #EPartType#
      , #ITEM_No#
      , #ITEM_Middle#
      , #Production_Place#
      , #Block_No#
      , #Serial#
      , #Sel_Revision#
      , #Standard#
      )
    </insert>

    <update id="UpdateEPart" parameterClass="EPart">
      UPDATE T_DEPART
      SET
      Title = #Title#
      , Oem_Lib_OID = #Oem_Lib_OID#
      , Car_Lib_OID = #Car_Lib_OID#
      , Material_OID = #Material_OID#
      , Division = #Division#
      , EPartType = #EPartType#
      , ITEM_No = #ITEM_No#
      , ITEM_Middle = #ITEM_Middle#
      , Production_Place = #Production_Place#
      , Block_No = #Block_No#
      , Serial = #Serial#
      , Sel_Revision = #Sel_Revision#
      , Standard = #Standard#
      WHERE OID = #OID#
    </update>

    <select id="SelRootChildList" parameterClass="EPart" resultClass="EPart">
      WITH RECURSIVE_QUERY(FromOID, ToOID) AS (
      SELECT FromOID
      ,ToOID
      FROM T_DEBOM_RELATIONSHIP
      WHERE FromOID = #FromOID#
      UNION ALL
      SELECT
      B.FromOID
      ,B.ToOID
      FROM T_DEBOM_RELATIONSHIP B, RECURSIVE_QUERY C
      WHERE B.FromOID = C.ToOID
      )
      SELECT
      E.*
      , F.*
      FROM RECURSIVE_QUERY D
      LEFT OUTER JOIN T_DOBJECT E ON E.OID = D.ToOID
      LEFT OUTER JOIN T_DEPART F ON F.OID = D.ToOID
    </select>

    <insert id="InsEBomStructure" parameterClass="EBom" >
      <selectKey type="pre" resultClass="int" property="OID">
        SELECT ISNULL(MAX(OID),0) + 1 AS OID FROM T_DEBOM_RELATIONSHIP
      </selectKey>
      INSERT INTO T_DEBOM_RELATIONSHIP
      ( OID
      , FromOID
      , ToOID
      , Count
      , Type
      , Ord
      , CreateDt
      , CreateUs
      )
      VALUES
      ( #OID#
      , #FromOID#
      , #ToOID#
      , #Count#
      , 'PART'
      , #Ord#
      , GETDATE()
      , #CreateUs#
      )
    </insert>

    <delete id="delEBomStructure" parameterClass="EBom" >
      DELETE FROM T_DEBOM_RELATIONSHIP
      WHERE 1 = 1
      <isNotNull property="OID">
        AND OID = #OID#
      </isNotNull>
      <isNotNull property="FromOID">
        AND FromOID = #FromOID#
      </isNotNull>
    <isNotNull property="ToOID">
        AND ToOID = #ToOID#
      </isNotNull>
    </delete>

    <update id="ReEBomStructure" parameterClass="EBom">
      UPDATE T_DEBOM_RELATIONSHIP
      SET
      FromOID = #FromOID#
      , ToOID = #ToOID#
      , Count = #Count#
      , Ord = #Ord#
      WHERE OID = #OldOID#
    </update>

    <update id="UdtEBomStructure" parameterClass="EBom">
      UPDATE T_DEBOM_RELATIONSHIP
      SET
      Count = #Count#
      , Ord = #Ord#
      WHERE 1 = 1 
      AND FromOID = #FromOID#
      AND ToOID = #ToOID#
    </update>

    <select id="SelRootChildEBomList" parameterClass="EBom" resultClass="EBom">
      WITH RECURSIVE_QUERY(OID, FromOID, ToOID, Type, Count, Ord) AS (
      SELECT
      OID
      , FromOID
      , ToOID
      , Type
      , Count
      , Ord
      FROM T_DEBOM_RELATIONSHIP
      WHERE FromOID = #FromOID#
      UNION ALL
      SELECT
      B.OID
      , B.FromOID
      , B.ToOID
      , B.Type
      , B.Count
      , B.Ord
      FROM T_DEBOM_RELATIONSHIP B, RECURSIVE_QUERY C
      WHERE B.FromOID = C.ToOID
      )
      SELECT *
      FROM RECURSIVE_QUERY
    </select>

    <select id="SelAllParentStructure" parameterClass="EBom" resultClass="EBom">
      WITH RECURSIVE_QUERY(OID, FromOID, ToOID, Ord, Count) AS (
      SELECT
      OID
      , FromOID
      , ToOID
      , Ord
      , Count
      FROM T_DEBOM_RELATIONSHIP
      WHERE ToOID = #ToOID#
      UNION ALL
      SELECT
      B.OID
      , B.FromOID
      , B.ToOID
      , B.Ord
      , B.Count
      FROM T_DEBOM_RELATIONSHIP B, RECURSIVE_QUERY C
      WHERE B.ToOID = C.FromOID
      )
      SELECT
      D.*
      FROM RECURSIVE_QUERY D
    </select>

    <select id="SelTempEPartObject" parameterClass="EPart" resultClass="EPart">
      SELECT *
      FROM T_DEPART_TEMP
      WHERE DeleteDt IS NULL
      AND Type = #Type#
      AND Orgin_OID = #Orgin_OID#
    </select>

    <insert id="InsTempEPart" parameterClass="EPart" >
      <selectKey type="pre" resultClass="int" property="OID">
        SELECT ISNULL(MAX(OID),0) + 1 AS OID FROM T_DEPART_TEMP
      </selectKey>
      INSERT INTO T_DEPART_TEMP
      ( OID
      , Orgin_OID
      , Type
      , CreateDt
      , CreateUs
      )
      VALUES
      ( #OID#
      , #Orgin_OID#
      , 'PART'
      , GETDATE()
      , #CreateUs#
      )
    </insert>

  </statements>
</sqlMap>