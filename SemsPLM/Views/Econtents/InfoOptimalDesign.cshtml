
@{
    Layout = null;
}

<div id="InfoOptimalDesign_@ViewBag.OID" class="info_project clearfix">
    <div class="info_menubar">
        <ul>
            <li class="tab info_focus" info="properties"><i class="fas fa-info-circle"></i> 기본 정보</li>
            <li class="tab" info="Apphis"><i class="fas fa-stream"></i> 결재이력</li>
        </ul>
    </div>
    <div class="project_content">

        <div class="project_basic clearfix">
            <div class="basic_info">
                <h3>@ViewBag.OptimalDesignDetail.Name</h3>
            </div>
            <div class="basic_image">
                <div class="image_inputbox">이미지<!--이미지 드래그 영역--></div>
                <div class="image_thumbnail"><!--이미지 썸네일 영역--></div>
            </div>
            <div class="basic_status">
                <div class="pointer_wrap">
                    @for (int i = 0; i < ViewBag.Status.Count; i++)
                    {
                        <div class="pointer" data-type="@ViewBag.Status[i].Type" data-Status="@ViewBag.Status[i].StatusOID" style="z-index: @(ViewBag.Status.Count - i);">
                            <div class="project_status">@ViewBag.Status[i].StatusNm</div>
                        </div>
                    }
                </div>
                <p>설명 : <span></span></p>
            </div>
        </div>
        <div id="properties" class="basic_grid">
            <div class="propertiesInfo">
                <table class="tableTopButtonBox" style="border-bottom:1px solid #c5c5c5;">
                    <tbody>
                        <tr>
                            <td>
                                <h3 style="padding-left:8px;"><i class="fas fa-file-alt"></i> &nbsp;최적설계 PROFILE</h3>
                            </td>
                            <td style="text-align: right;">
                                <button id="EditApprovalBtn_@ViewBag.OID" class="custom-button"><i class="fas fa-edit"></i> 결재</button>
                                <button id="EditBtn_@ViewBag.OID" class="custom-button"><i class="fas fa-edit"></i> 수정</button>
                                <button id="EditSaveBtn_@ViewBag.OID" class="custom-button"><i class="fas fa-check-square"></i> 저장</button>
                                <button id="EditCancelBtn_@ViewBag.OID" class="custom-button"><i class="fas fa-window-close"></i> 취소</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="scrollY" style="height:624px;">
                    <table class="optimalDesignTable">
                        <colgroup>
                            <col width="16%" />
                            <col width="16%" />
                            <col width="16%" />
                            <col width="12%" />
                            <col width="10%" />
                            <col width="10%" />
                            <col width="10%" />
                            <col width="10%" />
                        </colgroup>
                        <thead style="border-top:10px solid transparent;border-bottom:10px solid transparent;">
                            <tr>
                                <td>고객사</td>
                                <td>차종</td>
                                <td>제품</td>
                                <td>구분</td>
                                <td>반영단계</td>
                                <td>반영(건)</td>
                                <td>미반영(건)</td>
                                <td>합계(건)</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <input type="text" class="ModifiableCustomBox_@ViewBag.OID" style="text-align:center; width:160px;" value="@ViewBag.OptimalDesignDetail.Oem_Lib_Nm" readonly="readonly">
                                    <div id="InfoOptimalDesignOEM_@ViewBag.OID" class="ModifiableEditCustomBox_@ViewBag.OID"></div>
                                </td>
                                <td>
                                    <input type="text" class="ModifiableCustomBox_@ViewBag.OID" style="text-align:center; width:160px;" value="@ViewBag.OptimalDesignDetail.Car_Lib_Nm" readonly="readonly">
                                    <div id="InfoOptimalDesignCar_@ViewBag.OID" class="ModifiableEditCustomBox_@ViewBag.OID"></div>
                                </td>
                                <td><input type="text" value="@ViewBag.OptimalDesignDetail.Product" id="InfoOptimalDesignProduct_@ViewBag.OID" style="width:230px;"></td>
                                <td><input type="text" value="@ViewBag.OptimalDesignDetail.Division" id="InfoOptimalDesignDivision_@ViewBag.OID" style="width:160px;"></td>
                                <td><input type="text" value="시작" readonly="readonly" style="text-align:center" /></td>
                                <td><input type="text" value="@ViewBag.OptimalDesignDetail.ReflectedNum" id="InfoOptimalDesignTrue_@ViewBag.OID" readonly="readonly" style="text-align:center;" /></td>
                                <td><input type="text" value="@ViewBag.OptimalDesignDetail.NotReflectedNum" id="InfoOptimalDesignFalse_@ViewBag.OID" readonly="readonly" style="text-align:center" /></td>
                                <td><input type="text" id="InfoOptimalDesignTotal_@ViewBag.OID" readonly="readonly" style="text-align:center" /></td>
                            </tr>
                        </tbody>
                    </table>

                    <div id="InfoOptimalDesignGrid_@ViewBag.OID"></div>
                </div>
            </div>
        </div>

        <div id="Apphis" class="basic_grid dective">
            <div id="ApphisInfo_@ViewBag.OID">
            </div>
        </div>

    </div>
</div>



<script>

    $(function () {
        var OptimalDesignOID = "@ViewBag.OID";
        var InfoOptimalOem$ = $('#InfoOptimalDesignOEM_' + OptimalDesignOID);
        var InfoOptimalCar$ = $('#InfoOptimalDesignCar_' + OptimalDesignOID);
        var oemList = JSON.parse('@Html.Raw(Json.Encode(ViewBag.oemList))');

        var ItemParam = {};
        ItemParam.FromOID = OptimalDesignOID;


        const DocDiv$ = $('#InfoOptimalDesign_' + OptimalDesignOID);
        const headerStatus = $('#InfoOptimalDesign_' + OptimalDesignOID + ' .pointer_wrap .pointer');
        const current = @ViewBag.OptimalDesignDetail.BPolicyOID;

        if (headerStatus != null && headerStatus.length > 0) {
            headerStatus.removeClass('pointer_focus');
            const currentStatus = headerStatus.filter(function (index, item) {
                return item.getAttribute('data-Status') == current;
            });
            if (currentStatus != null && currentStatus.length > 0) {
                currentStatus[0].className += ' ' + 'pointer_focus';
            }
        }

        $('#EditApprovalBtn_' + OptimalDesignOID).on('click', function () {
            OpenApprovalDialog(function () {
                PageReload();
            }, null, { TargetOID: OptimalDesignOID }, '/Common/Approval', '결재');
        });

        var oemSource =
        {
            localdata: oemList,
            datatype: "json",
            datafields:
                [
                    { name: 'KorNm', type: 'string' },
                    { name: 'OID', type: 'int' },
                    { name: 'Code1', type: 'string' },
                    { name: 'Code2', type: 'string' },
                ]
        };
        var oemAdapter = new $.jqx.dataAdapter(oemSource);
        InfoOptimalOem$.jqxComboBox({ source: oemAdapter, displayMember: "KorNm", valueMember: "OID", width: 170, height: 32 });

        InfoOptimalOem$.on('change', function (evt) {
            var param = {};
            param.fromOID = InfoOptimalOem$.val();
            param.Code1 = '@Common.Constant.CommonConstant.ATTRIBUTE_CARTYPE';
            RequestData('/Manage/SelCodeLibraryChild', param, function (res) {

                var carSource =
                {
                    localdata: res,
                    datatype: "json",
                    datafields:
                        [
                            { name: 'KorNm', type: 'string' },
                            { name: 'OID', type: 'int' },
                            { name: 'Code1', type: 'string' },
                            { name: 'Code2', type: 'string' },
                        ]
                };
                var caradapter = new $.jqx.dataAdapter(carSource);
                InfoOptimalCar$.jqxComboBox({ source: caradapter, displayMember: "KorNm", valueMember: "OID", width: 170, height: 32 });
                InfoOptimalCar$.jqxComboBox('selectItem', "@ViewBag.OptimalDesignDetail.Car_Lib_OID");

            });
        });

        InfoOptimalOem$.jqxComboBox('selectItem', "@ViewBag.OptimalDesignDetail.Oem_Lib_OID");

        var InfoOptimalDesignGridSource = {
            datatype: 'json',
            datafields: [
                { name: 'OID' },
                { name: 'Name' },
                { name: 'BPolicyOID' },
                { name: 'BPolicy' },
                { name: 'CreateUsNm' },
                { name: 'CreateDt', type: 'date' },

                { name: 'Description' },

                { name: 'Problems_Lib_Name', type: 'string'},

                { name: 'Car_Lib_OID' },
                { name: 'Product' },
                { name: 'Part' },
                { name: 'Occurrence' },
                { name: 'Stage_Occurrence' },
                { name: 'Failure_Type' },
                { name: 'Division' },
                { name: 'Issues' },
                { name: 'Cause' },
                { name: 'Countermeasures' },

                { name: 'Reflected' },
                { name: 'ReflectVal' },

                { name: 'Revision' },
                { name: 'Problems_Lib_OID'},

            ],
        }

        const InfoOptimalDesignGrid$ = $('#InfoOptimalDesignGrid_@ViewBag.OID');
        InfoOptimalDesignGrid$.jqxGrid({
            theme: "kdnc",
            width: "99.8%",
            height: 540,
            rowsheight: 50,
            columnsheight: 30,
            sortable: false,
            editable: false,
            pageable: false,
            columns: [
                {
                    text: '순서', width: "3%", cellsalign: 'center', columntype: 'number', align: 'center', editable: false,
                    cellsrenderer: function (row, column, value) {
                        return "<div style='width:100%;height:100px;text-align:center;vertical-align:middle;line-height:50px;'>" + (value + 1) + "</div>";
                    }
                },
                { text: 'NO', datafield: 'Problems_Lib_Name', width: "7%", align: 'center', cellsalign: 'center', editable: false, },
                { text: '과거차 문제', datafield: 'Issues', width: "13%", align: 'center', cellsalign: 'center', editable: false, },
                { text: '과거차 문제 개선 대책 ', datafield: 'Countermeasures', width: "13%", align: 'center', cellsalign: 'center', editable: false, },
                { text: '구분', datafield: 'Division', width: "13%", align: 'center', cellsalign: 'center', editable: false, },
                {
                    text: '반영/미반영', width: "7%", align: 'center', cellsalign: 'center',
                    columntype: 'custom',

                    createeditor: function (row, column, editor) {
                        var div = $('<div style="text-align:center;vertical-align:middle; height:100%;">');
                        var element = $('<div style="text-align:center;vertical-align:middle; height:50%;" id=\'jqxRadioButtonTrue\'>반  영</div><div style="text-align:center;vertical-align:middle; height:50%;"  id=\'jqxRadioButtonFalse\'>미 반 영</div>');
                        div.append(element);
                        editor.append(div);
                        element.jqxRadioButton({
                            groupName: "Reflected"
                        });
                    },
                    initeditor: function (row, cellvalue, editor, celltext, pressedChar) {
                        if (cellvalue) {
                            var radioButtons = editor.children();
                            for (var i = 0; i < radioButtons.length; i++) {
                                if ($(radioButtons[i]).text() === cellvalue) {
                                    $(radioButtons[i]).val(true);
                                    break;
                                }
                            }
                        }
                    },
                    geteditorvalue: function (row, cellvalue, editor) {
                        var radioButtons = editor.children().children(),
                            firstRadioButton = $(radioButtons[0]),
                            secondRadioButton = $(radioButtons[1]);
                        if (firstRadioButton.val() === true) {
                            InfoOptimalDesignGrid$.jqxGrid('setcellvalue', row, "Reflected", "true");

                            var rowdata = InfoOptimalDesignGrid$.jqxGrid('getrows');

                            var TrueNum = 0;
                            var FalseNum = 0;

                            for (var v = 0; v < rowdata.length; v++) {
                                if (rowdata[v].Reflected == "true") {
                                    TrueNum = TrueNum + 1;
                                } else if (rowdata[v].Reflected == "false") {
                                    FalseNum = FalseNum + 1;
                                }
                            }

                            $('#InfoOptimalDesignTrue_@ViewBag.OID').val(TrueNum);
                            $('#InfoOptimalDesignFalse_@ViewBag.OID').val(FalseNum);

                            return firstRadioButton.text();
                        } else if (secondRadioButton.val() === true) {
                            InfoOptimalDesignGrid$.jqxGrid('setcellvalue', row, "Reflected", "false");

                            var rowdata = InfoOptimalDesignGrid$.jqxGrid('getrows');

                            var TrueNum = 0;
                            var FalseNum = 0;

                            for (var v = 0; v < rowdata.length; v++) {
                                if (rowdata[v].Reflected == "true") {
                                    TrueNum = TrueNum + 1;
                                } else if (rowdata[v].Reflected == "false") {
                                    FalseNum = FalseNum + 1;
                                }
                            }

                            $('#InfoOptimalDesignTrue_@ViewBag.OID').val(TrueNum);
                            $('#InfoOptimalDesignFalse_@ViewBag.OID').val(FalseNum);

                            return secondRadioButton.text();
                        } else {
                            InfoOptimalDesignGrid$.jqxGrid('setcellvalue', row, "Reflected", "");
                            return "";
                        }
                    },
                    cellsrenderer: function (row, column, value) {
                        var value = InfoOptimalDesignGrid$.jqxGrid('getcellvalue', row, "Reflected");
                        if (value == "true") {
                            return '<div class="jqx-grid-cell-middle-align" style= "margin-top:15.5px;">반영</div>';
                        } else if (value == "false") {
                            return '<div class="jqx-grid-cell-middle-align" style= "margin-top:15.5px;">미반영</div>';
                        }
                    },
                },
                { text: '반영/미반영', datafield: 'Reflected',  width: "15%", align: 'center', cellsalign: 'center', hidden: true },
                { text: '사유', datafield: 'Description', width: "34%", align: 'center', cellsalign: 'center', },
                { text: '리비전', datafield: 'Revision', width: "10%", align: 'center', cellsalign: 'center', editable: false, },
            ],
            showtoolbar: false,
        });

        $('.ModifiableEditCustomBox_' + OptimalDesignOID).attr('hidden', true);


        $('#InfoOptimalDesign_' + OptimalDesignOID + ' .tab').on('click', function () {
            const self$ = $(this);
            const infoValue = self$.attr('info');
            //control side menu
            DocDiv$.find('[class="tab info_focus"]').removeClass('info_focus');
            self$.addClass('info_focus');
            DocDiv$.find('[class="basic_grid"]').addClass('dective');
            DocDiv$.find('[id="' + infoValue + '"]').removeClass('dective');

            if (infoValue == 'properties') {
                $('#EditBtn_@ViewBag.OID').on('click', function () {
                    $('.Modifiable_@ViewBag.OID').removeAttr('readonly');
                    $('.ModifiableCustomBox_@ViewBag.OID').attr('hidden', true);
                    $('.ModifiableEditCustomBox_@ViewBag.OID').attr('hidden', false);

                    $('.Modifiable_@ViewBag.OID').parent().css('position', 'relative');
                    $('.ModifiableEditCustomBox_@ViewBag.OID').parent().css('position', 'relative');

                    InfoOptimalDesignGrid$.jqxGrid('editable', true);
                });

            } else if (infoValue == 'Apphis') {
                RequestHtml('/Common/ApprovalHistory', { OID: OptimalDesignOID }, function (res) {
                    $('#ApphisInfo_' + OptimalDesignOID).html(res);
                });
            }
        });

        $('.info_focus').click();

        getSearchOptimalDesignItem(InfoOptimalDesignGridSource, InfoOptimalDesignGrid$, ItemParam)
    });



    function getSearchOptimalDesignItem(_Source, _Grid$, param) {
        RequestData("/Econtents/SelOptimalDesignItem", param, function (res) {
            if (res.length != 0) {
                $('#InfoOptimalDesignTotal_@ViewBag.OID').val(res.length);
            } else {
                $('#InfoOptimalDesignTotal_@ViewBag.OID').val(0);
            }

            PrintJqxGrid(_Source, _Grid$, res);
        });
    }
</script>
